CON

    XTAL        = cfg#XTAL
    XDIV        = cfg#XDIV
    XMUL        = cfg#XMUL
    XDIVP       = cfg#XDIVP
    XOSC        = cfg#XOSC
    XSEL        = cfg#XSEL
    XPPPP       = cfg#XPPPP
    CLOCKFREQ   = cfg#CLOCKFREQ
    SETFREQ     = cfg#SETFREQ
    ENAFREQ     = cfg#ENAFREQ

    LED         = cfg#LED1
    SER_RX      = cfg#SER_RX
    SER_TX      = cfg#SER_TX
    SER_BAUD    = 2_000_000

    CS          = 61
    SCK         = 60
    MOSI        = 59
    MISO        = 58

OBJ

    ser         : "com.serial.terminal.ansi"
    cfg         : "core.con.boardcfg.p2eval"
    io          : "io"
    time        : "time"
    mem         : "memory.flash.w25qxxx.spi"

VAR

    long _ser_cog, _mem_cog

PUB Main | uid[2], addr, offs, rd_tmp, lines

    Setup

    ser.printf("Dev ID: %x\n", mem.DeviceID)
    ser.printf("Mfr ID: %x\n", mem.ManufacturerID)
    ser.printf("JEDEC ID: %x\n", mem.JEDECID)
    mem.UID(@uid)
    ser.printf("UID: %x%x", uid[0], uid[1])

    lines := 0

    ser.position(0, 10)
    repeat addr from 0 to 16777215 step 16
        ser.printf("%x: ", addr)
        repeat offs from 0 to 15
            rd_tmp := mem.ReadByte(addr+offs)
            ser.hex(rd_tmp, 2)
            ser.char(" ")
        ser.Newline
        lines++
        if lines > 40
            lines := 0
            ser.CharIn
            ser.Position(0, 10)

    Flash(LED, 100)     ' Signal execution finished

PUB Setup
    clkset(ENAFREQ, CLOCKFREQ, XSEL)
    repeat until _ser_cog := ser.StartRXTX (SER_RX, SER_TX, 0, SER_BAUD)
    ser.Clear
    ser.PrintF("Serial terminal started\n")
    if _mem_cog := mem.Startx (CS, SCK, MOSI, MISO, 5_000_000, 0)
        ser.Printf("W25Qxxx driver started\n")
    else
        ser.Printf("W25Qxxx driver failed to start - halting\n")
        Flash(LED, 500)

PUB Flash(led_pin, delay_ms)

    io.Output(led_pin)
    repeat
        io.Toggle(led_pin)
        time.MSleep(delay_ms)

